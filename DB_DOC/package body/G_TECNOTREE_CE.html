<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF8" />
<script src="G_TECNOTREE_CE/report.js" type="text/javascript"></script>
<link href="G_TECNOTREE_CE/report.css" type="text/css" rel="stylesheet">
</head>
<body>
<div class="banner">
<table width="98%"><tr>
<td><h2 class="banner">G_TECNOTREE_CE</h2></td>
</tr></table></div>
<div id="maintabs">
<div class="currentmaintab" onclick="onSelectMainTab(this, 0)">
<div>
<p>Doc</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 1)">
<div>
<p>Details</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 2)">
<div>
<p>Grants</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 3)">
<div>
<p>References</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 4)">
<div>
<p>Dependencies</p>
</div>
</div>
<div class="maintab" onclick="onSelectMainTab(this, 5)">
<div>
<p>Code</p>
</div>
</div>
</div>
<br/>
<div id="masterreports">
<div id="Master.0">
<div class="currentmasterreport">
<TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE><HR><P> <BR>    FORMATO ENTRADA FECHAS DD-MON-YYYY 00:00:00, ej. 06-JAN-2016 00:00:00<BR>  </P><HR><TABLE CELLSPACING="0" CELLPADDING="1" WIDTH="100%" BORDER="0">
<TR><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2">      SUMMARY:  <A HREF="#field_summary">FIELD</A> | <A HREF="#type_summary">TYPE</A> | <A HREF="#method_summary">METHOD</A></FONT></TD><TD CLASS="NavBarRow3" VALIGN="top"><FONT SIZE="-2"></TR></TABLE></div>
</div>
<div id="Master.1">
<div class="masterreport">
<table id="Table.0" cellpadding="0" cellspacing="0" summary="">
<th>NAME</th>
<th>VALUE</th>
</tr>
<tr>
<td>OWNER</td>
<td>MCARRASCO</td>
</tr>
<tr>
<td>OBJECT_NAME</td>
<td>G_TECNOTREE_CE</td>
</tr>
<tr>
<td>SUBOBJECT_NAME</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_ID</td>
<td>108180</td>
</tr>
<tr>
<td>DATA_OBJECT_ID</td>
<td>null</td>
</tr>
<tr>
<td>OBJECT_TYPE</td>
<td>PACKAGE&nbsp;BODY</td>
</tr>
<tr>
<td>CREATED</td>
<td>30.06.2016&nbsp;09:54:35</td>
</tr>
<tr>
<td>LAST_DDL_TIME</td>
<td>14.07.2016&nbsp;12:38:40</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>2016-07-14:12:38:40</td>
</tr>
<tr>
<td>STATUS</td>
<td>VALID</td>
</tr>
<tr>
<td>TEMPORARY</td>
<td>N</td>
</tr>
<tr>
<td>GENERATED</td>
<td>N</td>
</tr>
<tr>
<td>SECONDARY</td>
<td>N</td>
</tr>
<tr>
<td>NAMESPACE</td>
<td>2</td>
</tr>
<tr>
<td>EDITION_NAME</td>
<td>null</td>
</tr>
<tr>
<td>SHARING</td>
<td>NONE</td>
</tr>
<tr>
<td>EDITIONABLE</td>
<td>Y</td>
</tr>
<tr>
<td>ORACLE_MAINTAINED</td>
<td>N</td>
</tr>
</table>
</div>
</div>
<div id="Master.2">
<div class="masterreport">
<table id="Table.1" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>PRIVILEGE</th>
<th>GRANTEE</th>
<th>GRANTABLE</th>
<th>GRANTOR</th>
<th>OBJECT_NAME</th>
</tr>
</table>
</div>
</div>
<div id="Master.3">
<div class="masterreport">
<table id="Table.2" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
</table>
</div>
</div>
<div id="Master.4">
<div class="masterreport">
<table id="Table.3" cellpadding="0" cellspacing="0" summary="">
<tr>
<th>NAME</th>
<th>OWNER</th>
<th>TYPE</th>
<th>OBJECT_ID</th>
<th>STATUS</th>
<th>TYPE_LINK</th>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 0)" class="currentrow">
<td class="currentcell">TEC_CE_CM_TPS_DAY</td>
<td class="currentcell">MCARRASCO</td>
<td class="currentcell">TABLE</td>
<td class="currentcell">108833</td>
<td class="currentcell">VALID</td>
<td class="currentcell">TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 1)">
<td>TEC_CE_CDC_TPS_DAY</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108815</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 2)">
<td>G_ERROR_LOG_NEW</td>
<td>MCARRASCO</td>
<td>PACKAGE</td>
<td>99869</td>
<td>VALID</td>
<td>PACKAGE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 3)">
<td>TEC_CE_CM_TPS_BH</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108835</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 4)">
<td>PLITBLM</td>
<td>PUBLIC</td>
<td>SYNONYM</td>
<td>6153</td>
<td>VALID</td>
<td>SYNONYM</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 5)">
<td>TEC_CE_CDC_TPS_BH</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108817</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 6)">
<td>TEC_CE_CDC_TPS_AUX_TEMPLATE</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108810</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 7)">
<td>TEC_CE_CDC_TPS_IBHW</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108819</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 8)">
<td>TEC_CE_CM_TPS_HOUR</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108831</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 9)">
<td>TEC_CE_CDC_TPS_HOUR</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108813</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 10)">
<td>TEC_CE_CM_TPS_IBHW</td>
<td>MCARRASCO</td>
<td>TABLE</td>
<td>108837</td>
<td>VALID</td>
<td>TABLE</td>
</tr>
<tr onclick="table_onSelectMasterRow(this, 3, 11)">
<td>G_TECNOTREE_CE</td>
<td>MCARRASCO</td>
<td>PACKAGE</td>
<td>108179</td>
<td>VALID</td>
<td>PACKAGE</td>
</tr>
</table>
</div>
</div>
<div id="Master.5">
<div class="masterreport">
<pre>
PACKAGE BODY G_TECNOTREE_CE AS 
  
  /**
  * FORMATO ENTRADA FECHAS DD-MON-YYYY 00:00:00, ej. 06-JAN-2016 00:00:00
  */
  PROCEDURE P_POPULAR_PLANTILLA(P_FECHA_INI IN VARCHAR2,P_RESULTADO OUT NUMBER) AS
    V_START_DTIME VARCHAR2(20 CHAR) := P_FECHA_INI;
    V_END         VARCHAR2(20 CHAR) := '';
    MAX_TPS       NUMBER            := 0;
    START_DTIME   VARCHAR2(20 CHAR) := '';
    END_DTIME     VARCHAR2(20 CHAR) := '';
    ESTA          BOOLEAN           := FALSE;
  BEGIN
    -- Calcular fecha fin
    SELECT  TO_CHAR(TO_DATE(V_START_DTIME,'DD-MON-YYYY HH24:MI:SS')+1,'DD-MON-YYYY HH24:MI:SS')
    INTO    V_END
    FROM DUAL;
    --
    WHILE (v_start_dtime != v_end AND NOT ESTA) LOOP
    BEGIN
      SELECT  to_char(TO_DATE(v_start_dtime,'DD-MON-YYYY HH24:MI:SS'),'DD-MON-YYYY HH24:MI:SS') start_dtime,
              to_char(TO_DATE(v_start_dtime,'DD-MON-YYYY HH24:MI:SS')+INTERVAL '5' MINUTE,'DD-MON-YYYY HH24:MI:SS') END_DTIME
      INTO  start_dtime,
            end_dtime
      FROM dual;
      --
      INSERT INTO TEC_CE_CDC_TPS_AUX_TEMPLATE(start_dtime,END_DTIME,pais,max_tps,max_cap_hw,max_cap_sw)
      VALUES (START_DTIME,END_DTIME,'ARG',0,1,1);
      --
      INSERT INTO TEC_CE_CDC_TPS_AUX_TEMPLATE(start_dtime,END_DTIME,pais,max_tps,max_cap_hw,max_cap_sw)
      VALUES (START_DTIME,END_DTIME,'PRY',0,1,1);
      --
      INSERT INTO TEC_CE_CDC_TPS_AUX_TEMPLATE(start_dtime,END_DTIME,pais,max_tps,max_cap_hw,max_cap_sw)
      VALUES (START_DTIME,END_DTIME,'URY',0,1,1);
  
      v_start_dtime := end_dtime;
      EXCEPTION
        WHEN OTHERS THEN
          G_ERROR_LOG_NEW.P_LOG_ERROR('P_POPULAR_PLANTILLA',
                        0,
                        'ERROR',
                        'Error en la insercion de datos en la plantilla '||v_start_dtime||' '||v_end);
          P_RESULTADO := 1;
          ESTA := TRUE;
      --dbms_output.put_line(v_start_dtime||' '||end_dtime||' '||v_end);
    END;
    END LOOP;
    COMMIT;
    IF NOT ESTA THEN 
      P_RESULTADO := 0;   
    END IF;    
    
  END P_POPULAR_PLANTILLA;
  --
  PROCEDURE P_TEC_CE_CDC_TPS_DAY(P_FECHA IN VARCHAR2) IS
  --
    TYPE t_tec_ce_cdc_tps_day_tab IS TABLE OF TEC_CE_CDC_TPS_DAY%ROWTYPE;
    v_tec_ce_cdc_tps_day_tab t_tec_ce_cdc_tps_day_tab;
    --
    l_errors NUMBER;
    l_errno  NUMBER;
    l_msg    VARCHAR2(4000 CHAR);
    l_idx    NUMBER;
    --
    CURSOR cur (P_FECHA VARCHAR2) IS
    SELECT  trunc(FECHA)                  FECHA,
            PAIS,
            round(nvl(SUM(MAX_TPS),0),2)  MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            round(nvl(AVG(UTIL_HW),0),2)  UTIL_HW,
            round(nvl(AVG(UTIL_SW),0),2)  UTIL_SW
    FROM  TEC_CE_CDC_TPS_HOUR
    WHERE trunc(FECHA) = TO_DATE(P_FECHA,'DD.MM.YYYY')
    GROUP BY trunc(FECHA),PAIS,MAX_CAP_HW,
            MAX_CAP_SW;
    --
  BEGIN
    OPEN cur(P_FECHA);
    LOOP
      FETCH cur BULK COLLECT INTO v_tec_ce_cdc_tps_day_tab LIMIT limit_in;
      BEGIN
        FORALL indice IN INDICES OF v_tec_ce_cdc_tps_day_tab
          INSERT INTO TEC_CE_CDC_TPS_DAY
          VALUES v_tec_ce_cdc_tps_day_tab(indice);
        
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
              L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
              L_MSG   := SQLERRM(-L_ERRNO);
              L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
              --
              g_error_log_new.P_LOG_ERROR('P_TEC_CE_CDC_TPS_DAY',
                                          L_ERRNO,
                                          L_MSG,
                                          'FECHA => '       ||v_tec_ce_cdc_tps_day_tab(indice).FECHA||
                                          ' PAIS => '       ||v_tec_ce_cdc_tps_day_tab(indice).PAIS||
                                          ' MAX_TPS => '    ||to_char(v_tec_ce_cdc_tps_day_tab(indice).MAX_TPS)||
                                          ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cdc_tps_day_tab(indice).MAX_CAP_HW)||
                                          ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cdc_tps_day_tab(indice).MAX_CAP_SW)||
                                          ' UTIL_HW => '    ||to_char(v_tec_ce_cdc_tps_day_tab(indice).UTIL_HW)||
                                          ' UTIL_SW => '    ||to_char(v_tec_ce_cdc_tps_day_tab(indice).UTIL_SW)
                                          );
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    
    EXCEPTION
      WHEN OTHERS THEN
        g_error_log_new.P_LOG_ERROR('P_TEC_CE_CDC_TPS_DAY',
                                    SQLCODE,
                                    SQLERRM,
                                    'Fallo al insertar los datos');
  END P_TEC_CE_CDC_TPS_DAY;
  --
  PROCEDURE P_TEC_CE_CDC_TPS_BH(P_FECHA IN VARCHAR2) AS
  --
    CURSOR cur(P_FECHA VARCHAR2) IS
    SELECT  FECHA,
            PAIS,
            MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            UTIL_HW,
            UTIL_SW
    FROM  (
          SELECT  to_char(FECHA,'dd.mm.yyyy HH24:MI') FECHA,
                  PAIS,
                  MAX_TPS,
                  MAX_CAP_HW,
                  MAX_CAP_SW,
                  UTIL_HW,
                  UTIL_SW,                
                  ROW_NUMBER() OVER (PARTITION BY TRUNC(FECHA,'DAY'),
                                                 PAIS
                              ORDER BY trunc(FECHA) DESC,
                                       PAIS DESC,
                                       MAX_TPS DESC NULLS LAST) SEQNUM
                FROM TEC_CE_CDC_TPS_HOUR
                WHERE trunc(FECHA) = TO_DATE(P_FECHA,'DD.MM.YYYY')
        )
        WHERE SEQNUM = 1;
    --
    TYPE t_tec_ce_cdc_tps_tab IS TABLE OF TEC_CE_CDC_TPS_BH%ROWTYPE;
    v_tec_ce_cdc_tps_tab t_tec_ce_cdc_tps_tab;
    --
    l_errors number;
    l_errno  number;
    l_msg    VARCHAR2(4000 CHAR);
    l_idx    number;
    --
  BEGIN
    execute immediate 'alter session set nls_date_format = ''DD.MM.YYYY HH24:MI:SS''';
    OPEN cur(P_FECHA);
    LOOP
      FETCH cur BULK COLLECT INTO v_tec_ce_cdc_tps_tab LIMIT limit_in;
      BEGIN
        FORALL indice IN INDICES OF v_tec_ce_cdc_tps_tab
          INSERT INTO TEC_CE_CDC_TPS_BH
          VALUES v_tec_ce_cdc_tps_tab(indice);
        
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
              L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
              L_MSG   := SQLERRM(-L_ERRNO);
              L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
              --
              g_error_log_new.P_LOG_ERROR('P_TEC_CE_CDC_TPS_BH',
                                          L_ERRNO,
                                          L_MSG,
                                          'FECHA => '       ||v_tec_ce_cdc_tps_tab(L_IDX).FECHA||
                                          ' PAIS => '       ||v_tec_ce_cdc_tps_tab(L_IDX).PAIS||
                                          ' MAX_TPS => '    ||to_char(v_tec_ce_cdc_tps_tab(L_IDX).MAX_TPS)||
                                          ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cdc_tps_tab(L_IDX).MAX_CAP_HW)||
                                          ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cdc_tps_tab(L_IDX).MAX_CAP_SW)||
                                          ' UTIL_HW => '    ||to_char(v_tec_ce_cdc_tps_tab(L_IDX).UTIL_HW)||
                                          ' UTIL_SW => '    ||to_char(v_tec_ce_cdc_tps_tab(L_IDX).UTIL_SW)
                                          );
            
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    
    EXCEPTION
      WHEN OTHERS THEN
        g_error_log_new.P_LOG_ERROR('P_TEC_CE_CDC_TPS_BH',
                                    SQLCODE,
                                    SQLERRM,
                                    'Fallo al abrir el cursor');
  END P_TEC_CE_CDC_TPS_BH;
  --
  PROCEDURE P_TEC_CE_CDC_TPS_IBHW(P_FECHA_DOMINGO IN VARCHAR2,P_FECHA_SABADO IN VARCHAR2)AS
  --
    CURSOR cur(fecha_desde varchar2, fecha_hasta varchar2) IS
    SELECT  fecha_desde FECHA,
            PAIS,
            round(NVL(AVG(MAX_TPS),0),2) MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            round(NVL(AVG(UTIL_HW),0),2) UTIL_HW,
            round(NVL(AVG(UTIL_SW),0),2) UTIL_SW
    FROM (
          SELECT  to_char(FECHA,'DD.MM.YYYY HH24:MI') FECHA,
                  PAIS,
                  MAX_TPS,
                  MAX_CAP_HW,
                  MAX_CAP_SW,
                  UTIL_HW,
                  UTIL_SW,                
                  ROW_NUMBER() OVER (PARTITION BY TRUNC(FECHA,'DAY'),
                                                 PAIS
                              ORDER BY --trunc(FECHA) DESC,
                                       --PAIS DESC,
                                       MAX_TPS DESC NULLS LAST) SEQNUM
                FROM TEC_CE_CDC_TPS_BH
                WHERE trunc(fecha) BETWEEN TO_DATE(fecha_desde,'DD.MM.YYYY') AND TO_DATE(fecha_hasta,'DD.MM.YYYY'))
    where SEQNUM &lt;= LIMIT_PROM
    --AND fecha BETWEEN to_date(fecha_desde,'DD.MM.YYYY') AND to_date(fecha_hasta,'DD.MM.YYYY')
    GROUP BY PAIS,MAX_CAP_HW,
            MAX_CAP_SW; --,fecha;
    --
    l_errors number;
    l_errno  number;
    l_msg    varchar2(4000);
    l_idx    number;
    --
    TYPE t_tec_ce_cdc_tps_ibhw_row IS TABLE OF TEC_CE_CDC_TPS_IBHW%rowtype;
    v_tec_ce_cdc_tps_ibhw_tab t_tec_ce_cdc_tps_ibhw_row;
    --
  BEGIN
  OPEN cur(P_FECHA_DOMINGO,P_FECHA_SABADO);
    LOOP
      FETCH cur bulk collect into v_tec_ce_cdc_tps_ibhw_tab limit limit_in;
      BEGIN
        FORALL indice IN 1 .. v_tec_ce_cdc_tps_ibhw_tab.COUNT SAVE EXCEPTIONS
          INSERT INTO TEC_CE_CDC_TPS_IBHW values v_tec_ce_cdc_tps_ibhw_tab(indice);
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
                L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
                L_MSG   := SQLERRM(-L_ERRNO);
                L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
                --
                G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_IBHW',
                                            l_errno,
                                            l_msg,
                                            'FECHA => '       ||v_tec_ce_cdc_tps_ibhw_tab(L_IDX).FECHA||
                                            ' PAIS => '       ||v_tec_ce_cdc_tps_ibhw_tab(L_IDX).PAIS||
                                            ' MAX_TPS => '    ||to_char(v_tec_ce_cdc_tps_ibhw_tab(L_IDX).MAX_TPS)||
                                            ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cdc_tps_ibhw_tab(L_IDX).MAX_CAP_HW)||
                                            ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cdc_tps_ibhw_tab(L_IDX).MAX_CAP_SW)||
                                            ' UTIL_HW => '    ||to_char(v_tec_ce_cdc_tps_ibhw_tab(L_IDX).UTIL_HW)||
                                            ' UTIL_SW => '    ||to_char(v_tec_ce_cdc_tps_ibhw_tab(L_IDX).UTIL_SW));
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    --
    EXCEPTION
      WHEN others THEN
        G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_IBHW',
                                    SQLCODE,
                                    SQLERRM,
                                    'P_FECHA_DOMINGO '||P_FECHA_DOMINGO||' P_FECHA_SABADO => '||P_FECHA_SABADO);
  END P_TEC_CE_CDC_TPS_IBHW;
  --
  PROCEDURE P_TEC_CE_CM_TPS_DAY(P_FECHA IN VARCHAR2)AS
  --
    TYPE t_tec_ce_cm_tps_day_tab IS TABLE OF TEC_CE_CM_TPS_DAY%ROWTYPE;
    v_tec_ce_cm_tps_day_tab t_tec_ce_cm_tps_day_tab;
    --
    l_errors NUMBER;
    l_errno  NUMBER;
    l_msg    VARCHAR2(4000 CHAR);
    l_idx    NUMBER;
    --
    CURSOR cur (P_FECHA VARCHAR2) IS
    SELECT  trunc(FECHA)                  FECHA,
            PAIS,
            round(nvl(SUM(MAX_TPS),0),2)  MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            round(nvl(AVG(UTIL_HW),0),2)  UTIL_HW,
            round(nvl(AVG(UTIL_SW),0),2)  UTIL_SW
    FROM  TEC_CE_CM_TPS_HOUR
    WHERE trunc(FECHA) = TO_DATE(P_FECHA,'DD.MM.YYYY')
    GROUP BY trunc(FECHA),PAIS,MAX_CAP_HW,
            MAX_CAP_SW;
    --
  BEGIN
    OPEN cur(P_FECHA);
    LOOP
      FETCH cur BULK COLLECT INTO v_tec_ce_cm_tps_day_tab LIMIT limit_in;
      BEGIN
        FORALL indice IN INDICES OF v_tec_ce_cm_tps_day_tab
          INSERT INTO TEC_CE_CM_TPS_DAY
          VALUES v_tec_ce_cm_tps_day_tab(indice);
        
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
              L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
              L_MSG   := SQLERRM(-L_ERRNO);
              L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
              --
              g_error_log_new.P_LOG_ERROR('P_TEC_CE_CM_TPS_DAY',
                                          L_ERRNO,
                                          L_MSG,
                                          'FECHA => '       ||v_tec_ce_cm_tps_day_tab(indice).FECHA||
                                          ' PAIS => '       ||v_tec_ce_cm_tps_day_tab(indice).PAIS||
                                          ' MAX_TPS => '    ||to_char(v_tec_ce_cm_tps_day_tab(indice).MAX_TPS)||
                                          ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cm_tps_day_tab(indice).MAX_CAP_HW)||
                                          ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cm_tps_day_tab(indice).MAX_CAP_SW)||
                                          ' UTIL_HW => '    ||to_char(v_tec_ce_cm_tps_day_tab(indice).UTIL_HW)||
                                          ' UTIL_SW => '    ||to_char(v_tec_ce_cm_tps_day_tab(indice).UTIL_SW)
                                          );
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    
    EXCEPTION
      WHEN OTHERS THEN
        g_error_log_new.P_LOG_ERROR('P_TEC_CE_CM_TPS_DAY',
                                    SQLCODE,
                                    SQLERRM,
                                    'Fallo al insertar los datos');
  END P_TEC_CE_CM_TPS_DAY;
  --
  PROCEDURE P_TEC_CE_CM_TPS_BH(P_FECHA IN VARCHAR2)AS
  --
    CURSOR cur(P_FECHA VARCHAR2) IS
    SELECT  FECHA,
            PAIS,
            MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            UTIL_HW,
            UTIL_SW
    FROM  (
          SELECT  to_char(FECHA,'DD.MM.YYYY HH24:MI') FECHA,
                  PAIS,
                  MAX_TPS,
                  MAX_CAP_HW,
                  MAX_CAP_SW,
                  UTIL_HW,
                  UTIL_SW,                
                  ROW_NUMBER() OVER (PARTITION BY TRUNC(FECHA,'DAY'),
                                                 PAIS
                              ORDER BY trunc(FECHA) DESC,
                                       PAIS DESC,
                                       MAX_TPS DESC NULLS LAST) SEQNUM
                FROM TEC_CE_CM_TPS_HOUR
                WHERE trunc(FECHA) = TO_DATE(P_FECHA,'DD.MM.YYYY')
        )
        WHERE SEQNUM = 1;
    --
    TYPE t_tec_ce_cm_tps_tab IS TABLE OF TEC_CE_CM_TPS_BH%ROWTYPE;
    v_tec_ce_cm_tps_tab t_tec_ce_cm_tps_tab;
    --
    l_errors number;
    l_errno  number;
    l_msg    VARCHAR2(4000 CHAR);
    l_idx    number;
    --
  BEGIN
    execute immediate 'alter session set nls_date_format = ''DD.MM.YYYY HH24:MI:SS''';
    OPEN cur(P_FECHA);
    LOOP
      FETCH cur BULK COLLECT INTO v_tec_ce_cm_tps_tab LIMIT limit_in;
      BEGIN
        FORALL indice IN INDICES OF v_tec_ce_cm_tps_tab
          INSERT INTO TEC_CE_CM_TPS_BH
          VALUES v_tec_ce_cm_tps_tab(indice);
        
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
              L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
              L_MSG   := SQLERRM(-L_ERRNO);
              L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
              --
              g_error_log_new.P_LOG_ERROR('P_TEC_CE_CM_TPS_BH',
                                          L_ERRNO,
                                          L_MSG,
                                          'FECHA => '       ||v_tec_ce_cm_tps_tab(L_IDX).FECHA||
                                          ' PAIS => '       ||v_tec_ce_cm_tps_tab(L_IDX).PAIS||
                                          ' MAX_TPS => '    ||to_char(v_tec_ce_cm_tps_tab(L_IDX).MAX_TPS)||
                                          ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cm_tps_tab(L_IDX).MAX_CAP_HW)||
                                          ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cm_tps_tab(L_IDX).MAX_CAP_SW)||
                                          ' UTIL_HW => '    ||to_char(v_tec_ce_cm_tps_tab(L_IDX).UTIL_HW)||
                                          ' UTIL_SW => '    ||to_char(v_tec_ce_cm_tps_tab(L_IDX).UTIL_SW)
                                          );
            
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    
    EXCEPTION
      WHEN OTHERS THEN
        g_error_log_new.P_LOG_ERROR('P_TEC_CE_CM_TPS_BH',
                                    SQLCODE,
                                    SQLERRM,
                                    'Fallo al abrir el cursor');
  END P_TEC_CE_CM_TPS_BH;
  --
  PROCEDURE P_TEC_CE_CM_TPS_IBHW(P_FECHA_DOMINGO IN VARCHAR2,P_FECHA_SABADO IN VARCHAR2)AS
  --
    CURSOR cur(fecha_desde varchar2, fecha_hasta varchar2) IS
    SELECT  fecha_desde FECHA,
            PAIS,
            round(NVL(AVG(MAX_TPS),0),2) MAX_TPS,
            MAX_CAP_HW,
            MAX_CAP_SW,
            round(NVL(AVG(UTIL_HW),0),2) UTIL_HW,
            round(NVL(AVG(UTIL_SW),0),2) UTIL_SW
    FROM (
          SELECT  to_char(FECHA,'DD.MM.YYYY HH24:MI') FECHA,
                  PAIS,
                  MAX_TPS,
                  MAX_CAP_HW,
                  MAX_CAP_SW,
                  UTIL_HW,
                  UTIL_SW,                
                  ROW_NUMBER() OVER (PARTITION BY TRUNC(FECHA,'DAY'),
                                                 PAIS
                              ORDER BY --trunc(FECHA) DESC,
                                       --PAIS DESC,
                                       MAX_TPS DESC NULLS LAST) SEQNUM
                FROM TEC_CE_CM_TPS_BH
                WHERE trunc(fecha) BETWEEN TO_DATE(fecha_desde,'DD.MM.YYYY') AND TO_DATE(fecha_hasta,'DD.MM.YYYY'))
    where SEQNUM &lt;= LIMIT_PROM
    --AND fecha BETWEEN to_date(fecha_desde,'DD.MM.YYYY') AND to_date(fecha_hasta,'DD.MM.YYYY')
    GROUP BY PAIS,MAX_CAP_HW,
            MAX_CAP_SW; --,fecha;
    --
    l_errors number;
    l_errno  number;
    l_msg    varchar2(4000);
    l_idx    number;
    --
    TYPE t_tec_ce_cm_tps_ibhw_row IS TABLE OF TEC_CE_CM_TPS_IBHW%rowtype;
    v_tec_ce_cm_tps_ibhw_tab t_tec_ce_cm_tps_ibhw_row;
    --
  BEGIN
  OPEN cur(P_FECHA_DOMINGO,P_FECHA_SABADO);
    LOOP
      FETCH cur bulk collect into v_tec_ce_cm_tps_ibhw_tab limit limit_in;
      BEGIN
        FORALL indice IN 1 .. v_tec_ce_cm_tps_ibhw_tab.COUNT SAVE EXCEPTIONS
          INSERT INTO TEC_CE_CM_TPS_IBHW values v_tec_ce_cm_tps_ibhw_tab(indice);
        EXCEPTION
          WHEN OTHERS THEN
            L_ERRORS := SQL%BULK_EXCEPTIONS.COUNT;
            FOR indice IN 1 .. L_ERRORS
            LOOP
                L_ERRNO := SQL%BULK_EXCEPTIONS(indice).ERROR_CODE;
                L_MSG   := SQLERRM(-L_ERRNO);
                L_IDX   := SQL%BULK_EXCEPTIONS(indice).ERROR_INDEX;
                --
                G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_IBHW',
                                            l_errno,
                                            l_msg,
                                            'FECHA => '       ||v_tec_ce_cm_tps_ibhw_tab(L_IDX).FECHA||
                                            ' PAIS => '       ||v_tec_ce_cm_tps_ibhw_tab(L_IDX).PAIS||
                                            ' MAX_TPS => '    ||to_char(v_tec_ce_cm_tps_ibhw_tab(L_IDX).MAX_TPS)||
                                            ' MAX_CAP_HW => ' ||to_char(v_tec_ce_cm_tps_ibhw_tab(L_IDX).MAX_CAP_HW)||
                                            ' MAX_CAP_SW => ' ||to_char(v_tec_ce_cm_tps_ibhw_tab(L_IDX).MAX_CAP_SW)||
                                            ' UTIL_HW => '    ||to_char(v_tec_ce_cm_tps_ibhw_tab(L_IDX).UTIL_HW)||
                                            ' UTIL_SW => '    ||to_char(v_tec_ce_cm_tps_ibhw_tab(L_IDX).UTIL_SW));
            END LOOP;
      END;
      EXIT WHEN cur%NOTFOUND;
    END LOOP;
    COMMIT;
    CLOSE cur;
    --
    EXCEPTION
      WHEN others THEN
        G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_IBHW',
                                    SQLCODE,
                                    SQLERRM,
                                    'P_FECHA_DOMINGO '||P_FECHA_DOMINGO||' P_FECHA_SABADO => '||P_FECHA_SABADO);
  END P_TEC_CE_CM_TPS_IBHW;
  --
  PROCEDURE P_CALCULAR_SUM_TEC_CM_CDC(P_FECHA IN VARCHAR2)AS
    v_dia VARCHAR2(10 CHAR) := '';
  BEGIN
    --
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_DAY',0,'NO ERROR','COMIENZO DE SUMARIZACION DAY P_TEC_CE_CM_TPS_DAY('||P_FECHA||')');
    P_TEC_CE_CM_TPS_DAY(P_FECHA);
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_DAY',0,'NO ERROR','FIN DE SUMARIZACION DAY');
    --
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_DAY',0,'NO ERROR','COMIENZO DE SUMARIZACION DAY P_TEC_CE_CDC_TPS_DAY('||P_FECHA||')');
    P_TEC_CE_CDC_TPS_DAY(P_FECHA);
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_DAY',0,'NO ERROR','FIN DE SUMARIZACION DAY');
    --
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_BH',0,'NO ERROR','COMIENZO CALCULO BH P_TEC_CE_CM_TPS_BH('||P_FECHA||')');
    P_TEC_CE_CM_TPS_BH(P_FECHA);
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_BH',0,'NO ERROR','FIN CALCULO BH');
    --
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_BH',0,'NO ERROR','COMIENZO CALCULO BH P_TEC_CE_CDC_TPS_BH('||P_FECHA||')');
    P_TEC_CE_CDC_TPS_BH(P_FECHA);
    G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_BH',0,'NO ERROR','FIN CALCULO BH');
    --
    -- Si el dia actual es DOMINGO, entonces calcular sumarizacion IBHW de la semana anterior,
    -- siempre de domingo a sabado
    --
    SELECT TO_CHAR(TO_DATE(P_FECHA,'DD.MM.YYYY'),'DAY')
    INTO V_DIA
    FROM DUAL;
    
    IF (TRIM(V_DIA) = 'SUNDAY') OR (TRIM(V_DIA) = 'DOMINGO') THEN
      G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_IBHW',0,'NO ERROR','COMIENZO DE SUMARIZACION IBHW P_FECHA_DOMINGO => '||
                                  to_char(to_date(P_FECHA,'DD.MM.YYYY')-7,'DD.MM.YYYY')||
                                  ' P_FECHA_SABADO => '||TO_CHAR(TO_DATE(P_FECHA,'DD.MM.YYYY')-1,'DD.MM.YYYY'));
      --
      P_TEC_CE_CM_TPS_IBHW(to_char(to_date(P_FECHA,'DD.MM.YYYY')-7,'DD.MM.YYYY'),TO_CHAR(TO_DATE(P_FECHA,'DD.MM.YYYY')-1,'DD.MM.YYYY'));
      --
      G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CM_TPS_IBHW',0,'NO ERROR','FIN DE SUMARIZACION IBHW');
      --
      G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_IBHW',0,'NO ERROR','COMIENZO DE SUMARIZACION IBHW P_FECHA_DOMINGO => '||
                                  to_char(to_date(P_FECHA,'DD.MM.YYYY')-7,'DD.MM.YYYY')||
                                  ' P_FECHA_SABADO => '||TO_CHAR(TO_DATE(P_FECHA,'DD.MM.YYYY')-1,'DD.MM.YYYY'));
      --
      P_TEC_CE_CDC_TPS_IBHW(to_char(to_date(P_FECHA,'DD.MM.YYYY')-7,'DD.MM.YYYY'),TO_CHAR(TO_DATE(P_FECHA,'DD.MM.YYYY')-1,'DD.MM.YYYY'));
      --
      G_ERROR_LOG_NEW.P_LOG_ERROR('P_TEC_CE_CDC_TPS_IBHW',0,'NO ERROR','FIN DE SUMARIZACION IBHW');
    END IF;
  END P_CALCULAR_SUM_TEC_CM_CDC;
  --
END G_TECNOTREE_CE;</pre>
</div>
</div>
</div>
</body>
</html>
